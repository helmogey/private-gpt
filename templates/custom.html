<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom Chat</title>
    <style>
        /* Add some fancy CSS here */
        body { font-family: sans-serif; background-color: #121212; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .message { padding: 10px; border-radius: 10px; margin-bottom: 10px; max-width: 70%; word-wrap: break-word; }
        .user { background-color: #3a3a3a; align-self: flex-end; margin-left: auto; }
        .assistant { background-color: #2a2a2a; }
        #chat-form { display: flex; padding: 20px; border-top: 1px solid #333; }
        #chat-input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #444; background-color: #333; color: #fff; font-size: 16px; }
        #chat-form button { padding: 10px 20px; margin-left: 10px; border: none; background-color: #7E57C2; color: white; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="messages"></div>
    <form id="chat-form">
        <input id="chat-input" type="text" autocomplete="off" placeholder="Ask a question...">
        <button type="submit">Send</button>
    </form>

    <script>
        const form = document.getElementById('chat-form');
        const input = document.getElementById('chat-input');
        const messagesDiv = document.getElementById('messages');
        let conversationHistory = [];

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = input.value;
            if (!messageText) return;

            // 1. Display user's message
            appendMessage('user', messageText);
            conversationHistory.push({ role: 'user', content: messageText });
            input.value = '';

            // 2. Create a placeholder for the bot's response
            const botMessageDiv = appendMessage('assistant', '');
            
            // 3. Call the backend API
            const response = await fetch('/chat/stream', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: conversationHistory })
            });

            // 4. Handle the streaming response
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let botResponseText = '';

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                botResponseText += chunk;
                botMessageDiv.textContent = botResponseText; // Update the placeholder in real-time
                messagesDiv.scrollTop = messagesDiv.scrollHeight; // Auto-scroll
            }

            conversationHistory.push({ role: 'assistant', content: botResponseText });
        });

        function appendMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', role);
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }
    </script>
</body>
</html>
